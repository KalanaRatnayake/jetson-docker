name: 03. Orchestrate r36.3.0 pipeline

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: orchestrate-r3630-${{ github.ref }}
  cancel-in-progress: false

jobs:
  dispatch-sequence:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build PyTorch r36.3.0
        env:
          WORKFLOW_FILE: .github/workflows/r3630-pytorch.yml
          REF: main
          LABEL: Build PyTorch r36.3.0
        run: |
          set -euo pipefail
          owner_repo="${GITHUB_REPOSITORY}"
          api="${GITHUB_API_URL:-https://api.github.com}"
          token="${{ secrets.GITHUB_TOKEN }}"
          start="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Dispatching $LABEL for $WORKFLOW_FILE at $start"
          curl -sSL -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $token" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/dispatches" \
            -d "{\"ref\":\"$REF\"}"
          echo "Waiting for run to start..."
          attempt=0
          run_id=""
          while [ $attempt -lt 120 ]; do
            runs_json="$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/runs?event=workflow_dispatch&branch=$REF&per_page=5")"
            run_id=$(echo "$runs_json" | jq -r ".workflow_runs[] | select(.created_at >= \"$start\") | .id" | head -n1)
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              break
            fi
            sleep 5
            attempt=$((attempt+1))
          done
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "Failed to find dispatched run for $WORKFLOW_FILE" >&2
            exit 1
          fi
          echo "Run id: $run_id"
          echo "Polling run status..."
          for i in $(seq 1 720); do
            run_json=$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/runs/$run_id")
            status=$(echo "$run_json" | jq -r .status)
            conclusion=$(echo "$run_json" | jq -r .conclusion)
            echo "status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              test "$conclusion" = "success"
              exit $?
            fi
            sleep 10
          done
          echo "Timeout waiting for $WORKFLOW_FILE" >&2
          exit 1

      - name: Build ROS Humble Core r36.3.0
        env:
          WORKFLOW_FILE: .github/workflows/r3630-humblecore.yml
          REF: main
          LABEL: Build ROS Humble Core r36.3.0
        run: |
          set -euo pipefail
          owner_repo="${GITHUB_REPOSITORY}"
          api="${GITHUB_API_URL:-https://api.github.com}"
          token="${{ secrets.GITHUB_TOKEN }}"
          start="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Dispatching $LABEL for $WORKFLOW_FILE at $start"
          curl -sSL -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $token" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/dispatches" \
            -d "{\"ref\":\"$REF\"}"
          echo "Waiting for run to start..."
          attempt=0
          run_id=""
          while [ $attempt -lt 120 ]; do
            runs_json="$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/runs?event=workflow_dispatch&branch=$REF&per_page=5")"
            run_id=$(echo "$runs_json" | jq -r ".workflow_runs[] | select(.created_at >= \"$start\") | .id" | head -n1)
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              break
            fi
            sleep 5
            attempt=$((attempt+1))
          done
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "Failed to find dispatched run for $WORKFLOW_FILE" >&2
            exit 1
          fi
          echo "Run id: $run_id"
          echo "Polling run status..."
          for i in $(seq 1 720); do
            run_json=$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/runs/$run_id")
            status=$(echo "$run_json" | jq -r .status)
            conclusion=$(echo "$run_json" | jq -r .conclusion)
            echo "status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              test "$conclusion" = "success"
              exit $?
            fi
            sleep 10
          done
          echo "Timeout waiting for $WORKFLOW_FILE" >&2
          exit 1

      - name: Build ROS Humble Base r36.3.0
        env:
          WORKFLOW_FILE: .github/workflows/r3630-humblebase.yml
          REF: main
          LABEL: Build ROS Humble Base r36.3.0
        run: |
          set -euo pipefail
          owner_repo="${GITHUB_REPOSITORY}"
          api="${GITHUB_API_URL:-https://api.github.com}"
          token="${{ secrets.GITHUB_TOKEN }}"
          start="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Dispatching $LABEL for $WORKFLOW_FILE at $start"
          curl -sSL -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $token" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/dispatches" \
            -d "{\"ref\":\"$REF\"}"
          echo "Waiting for run to start..."
          attempt=0
          run_id=""
          while [ $attempt -lt 120 ]; do
            runs_json="$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/runs?event=workflow_dispatch&branch=$REF&per_page=5")"
            run_id=$(echo "$runs_json" | jq -r ".workflow_runs[] | select(.created_at >= \"$start\") | .id" | head -n1)
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              break
            fi
            sleep 5
            attempt=$((attempt+1))
          done
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "Failed to find dispatched run for $WORKFLOW_FILE" >&2
            exit 1
          fi
          echo "Run id: $run_id"
          echo "Polling run status..."
          for i in $(seq 1 720); do
            run_json=$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/runs/$run_id")
            status=$(echo "$run_json" | jq -r .status)
            conclusion=$(echo "$run_json" | jq -r .conclusion)
            echo "status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              test "$conclusion" = "success"
              exit $?
            fi
            sleep 10
          done
          echo "Timeout waiting for $WORKFLOW_FILE" >&2
          exit 1

      - name: Build ROS + PyTorch Humble Core r36.3.0
        env:
          WORKFLOW_FILE: .github/workflows/r3630-pytorch-humblecore.yml
          REF: main
          LABEL: Build ROS + PyTorch Humble Core r36.3.0
        run: |
          set -euo pipefail
          owner_repo="${GITHUB_REPOSITORY}"
          api="${GITHUB_API_URL:-https://api.github.com}"
          token="${{ secrets.GITHUB_TOKEN }}"
          start="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Dispatching $LABEL for $WORKFLOW_FILE at $start"
          curl -sSL -X POST -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $token" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/dispatches" \
            -d "{\"ref\":\"$REF\"}"
          echo "Waiting for run to start..."
          attempt=0
          run_id=""
          while [ $attempt -lt 120 ]; do
            runs_json="$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/workflows/$(basename "$WORKFLOW_FILE")/runs?event=workflow_dispatch&branch=$REF&per_page=5")"
            run_id=$(echo "$runs_json" | jq -r ".workflow_runs[] | select(.created_at >= \"$start\") | .id" | head -n1)
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              break
            fi
            sleep 5
            attempt=$((attempt+1))
          done
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "Failed to find dispatched run for $WORKFLOW_FILE" >&2
            exit 1
          fi
          echo "Run id: $run_id"
          echo "Polling run status..."
          for i in $(seq 1 720); do
            run_json=$(curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $token" "$api/repos/$owner_repo/actions/runs/$run_id")
            status=$(echo "$run_json" | jq -r .status)
            conclusion=$(echo "$run_json" | jq -r .conclusion)
            echo "status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              test "$conclusion" = "success"
              exit $?
            fi
            sleep 10
          done
          echo "Timeout waiting for $WORKFLOW_FILE" >&2
          exit 1
